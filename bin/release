#!/bin/bash

set -e -u
export LEIN_SNAPSHOTS_IN_RELEASE=1
RELEASE_VERSION=$1
CURRENT_VERSION="$RELEASE_VERSION-SNAPSHOT"

for f in bin/carneades src/CarneadesWeb/server/project.clj src/CarneadesWeb/client/bower.json; do
    sed -i s/$CURRENT_VERSION/$RELEASE_VERSION/ $f
done

rm -rf src/CarneadesEngine/target src/CarneadesWeb/server/target src/CarneadesWeb/client/dist src/CarneadesWeb/client/.generated src/CarneadesWeb/client/bower_components src/CarneadesWeb/client/node_modules src/CarneadesWeb/client/.sass-cache tmp

rm -rf $HOME/.carneades/self-installs/carneades-web-$RELEASE_VERSION-standalone.jar

cd src/CarneadesEngine
lein clean
lein install

cd ../CarneadesWeb/client
npm install
grunt build

cd ../server
lein clean
lein install

lein with-profile jar ring uberjar
RELEASE_JAR=$PWD/target/carneades-web-$RELEASE_VERSION-standalone.jar
mkdir ../../../tmp
cp $RELEASE_JAR ../../../tmp
cd ../../..
cp .carneades.clj.tpl tmp
cp -R projects/ tmp

cd tmp
RELEASE_ZIP=$PWD/carneades-web-$RELEASE_VERSION-standalone.zip
zip -r carneades-web-$RELEASE_VERSION-standalone.zip .
cd ..

#git commit -a -m "Release $RELEASE_VERSION"
#git tag -s $RELEASE_VERSION -m "Release $RELEASE_VERSION"
#git push && git push --tags && git push origin master:stable
echo ""
echo "Upload $RELEASE_ZIP to GitHub releases for $RELEASE_VERSION."
rm -rf src/CarneadesEngine/target src/CarneadesWeb/server/target src/CarneadesWeb/client/dist src/CarneadesWeb/client/.generated src/CarneadesWeb/client/.sass-cache
echo "Test self-install. If things are good, run this:"
echo "Now deploy the zip archive"
echo "And announce it on the mailing list."
